<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="viewport" content="width=480">

    <link rel="stylesheet" type="text/css" media="screen" href="/capnproto/stylesheets/stylesheet.css">

    <title>Cap'n Proto: FAQ</title>

    <script type="text/javascript" src="/capnproto/javascripts/main.js"></script>
  </head>

  <body class="desktop">

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
      <header class="inner">
        <img src="/capnproto/images/logo.png">
        <div id="infinitely_faster">
          <img src="/capnproto/images/infinitely_faster.png">
        </div>
      </header>
      <a id="discuss_banner" href="https://groups.google.com/group/capnproto">Discuss on Groups</a>
      <a id="forkme_banner" href="https://github.com/kentonv/capnproto">View on GitHub</a>
    </div>

    

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">

      <section id="menu">
        <ul>
          <li><a href="/capnproto/index.html">Introduction</a></li>
          <li><a href="/capnproto/news/">News</a></li>
          <li><a href="/capnproto/install.html">Installation</a></li>
          <li><a href="/capnproto/language.html">Schema Language</a></li>
          <li><a href="/capnproto/encoding.html">Encoding</a></li>
          <li><a href="/capnproto/rpc.html">RPC Protocol</a></li>
          <li><a href="/capnproto/capnp-tool.html">The <code>capnp</code> Tool</a></li>
          <li><a href="/capnproto/cxx.html">C++ Serialization</a></li>
          <li><a href="/capnproto/cxxrpc.html">C++ RPC</a></li>
          <li><a href="/capnproto/otherlang.html">Other Languages</a></li>
          <li><a href="/capnproto/roadmap.html">Road Map</a></li>
          <li><a href="/capnproto/faq.html">FAQ</a></li>
        </ul>
      </section>
      <section id="main_content" class="inner">

<h1 id="faq">FAQ</h1>

<h2 id="design">Design</h2>

<h3 id="isnt_io_bandwidth_more_important_than_cpu_usage_is_capn_proto_barking_up_the_wrong_tree">Isn’t I/O bandwidth more important than CPU usage? Is Cap’n Proto barking up the wrong tree?</h3>

<p>It depends. What is your use case?</p>

<p>Are you communicating between two processes on the same machine? If so, you have unlimited bandwidth, and you should be entirely concerned with CPU.</p>

<p>Are you communicating between two machines within the same datacenter? If so, it’s unlikely that you will saturate your network connection before your CPU. Possible, but unlikely.</p>

<p>Are you communicating across the general internet? In that case, bandwidth is probably your main concern. Luckily, Cap’n Proto lets you choose to enable “packing” in this case, achieving similar encoding size to Protocol Buffers while still being faster. And you can always add extra compression on top of that.</p>

<h3 id="have_you_considered_building_the_rpc_system_on_zeromq">Have you considered building the RPC system on ZeroMQ?</h3>

<p>ZeroMQ (and its successor, Nanomsg) is a powerful technology for distributed computing. Its design focuses on scenarios involving lots of stateless, fault-tolerant worker processes communicating via various patterns, such as request/response, produce/consume, and publish/subscribe. For big data processing where armies of stateless nodes make sense, pairing Cap’n Proto with ZeroMQ would be an excellent choice – and this is easy to do today, as ZeroMQ is entirely serialization-agnostic.</p>

<p>That said, Cap’n Proto RPC takes a very different approach. Cap’n Proto’s model focuses on stateful servers interacting in complex, object-oriented ways. The model is better suited to tasks involving applications with many heterogeneous components and interactions between mutually-distrusting parties. Requests and responses can go in any direction. Objects have state and so two calls to the same object had best go to the same machine. Load balancing and fault tolerance is pushed up the stack, because without a large pool of homogeneous work there’s just no way to make them transparent at a low level.</p>

<p>Put concretely, you might build a search engine indexing pipeline on ZeroMQ, but an online interactive spreadsheet editor would be better built on Cap’n Proto RPC.</p>

<p>(Actually, a distributed programming framework providing similar features to ZeroMQ could itself be built on top of Cap’n Proto RPC.)</p>

<h3 id="arent_messages_that_contain_pointers_a_huge_security_problem">Aren’t messages that contain pointers a huge security problem?</h3>

<p>Not at all. Cap’n Proto bounds-checks each pointer when it is read and throws an exception or returns a safe dummy value (your choice) if the pointer is out-of-bounds.</p>

<h3 id="so_its_not_that_youve_eliminated_parsing_youve_just_moved_it_to_happen_lazily">So it’s not that you’ve eliminated parsing, you’ve just moved it to happen lazily?</h3>

<p>No. Compared to Protobuf decoding, the time spent validating pointers while traversing a Cap’n Proto message is negligible.</p>

<h3 id="i_think_i_heard_somewhere_that_capabilitybased_security_doesnt_work">I think I heard somewhere that capability-based security doesn’t work?</h3>

<p>This was a popular myth in security circles way back in the 80’s and 90’s, based on an incomplete understanding of what capabilities are and how to use them effectively. Read <a href="http://srl.cs.jhu.edu/pubs/SRL2003-02.pdf">Capability Myths Demolished</a>. (No really, read it; it’s awesome.)</p>

<h2 id="usage">Usage</h2>

<h3 id="how_do_i_make_a_field_required_like_in_protocol_buffers">How do I make a field “required”, like in Protocol Buffers?</h3>

<p>You don’t. You may find this surprising, but the “required” keyword in Protocol Buffers turned out to be a horrible mistake.</p>

<p>For background, in protocol buffers, a field could be marked “required” to indicate that parsing should fail if the sender forgot to set the field before sending the message. Required fields were encoded exactly the same as optional ones; the only difference was the extra validation.</p>

<p>The problem with this is, validation is sometimes more subtle than that. Sometimes, different applications – or different parts of the same application, or different versions of the same application – place different requirements on the same protocol. An application may want to pass around partially-complete messages internally. A particular field that used to be required might become optional. A new use case might call for almost exactly the same message type, minus one field, at which point it may make more sense to reuse the type than to define a new one.</p>

<p>A field declared required, unfortunately, is required everywhere. The validation is baked into the parser, and there’s nothing you can do about it. Nothing, that is, except change the field from “required” to “optional”. But that’s where the <em>real</em> problems start.</p>

<p>Imagine a production environment in which two servers, Alice and Bob, exchange messages through a message bus infrastructure running on a big corporate network. The message bus parses each message just to examine the envelope and decide how to route it, without paying attention to any other content. Often, messages from various applications are batched together and then split up again downstream.</p>

<p>Now, at some point, Alice’s developers decide that one of the fields in a deeply-nested message commonly sent to Bob has become obsolete. To clean things up, they decide to remove it, so they change the field from “required” to “optional”. The developers aren’t idiots, so they realize that Bob needs to be updated as well. They make the changes to Bob, and just to be thorough they run an integration test with Alice and Bob running in a test environment. The test environment is always running the latest build of the message bus, but that’s irrelevant anyway because the message bus doesn’t actually care about message contents; it only does routing. Protocols are modified all the time without updating the message bus.</p>

<p>Satisfied with their testing, the devs push a new version of Alice to prod. Immediately, everything breaks. And by “everything” I don’t just mean Alice and Bob. Completely unrelated servers are getting strange errors or failing to receive messages. The whole data center has ground to a halt and the sysadmins are running around with their hair on fire.</p>

<p>What happened? Well, the message bus running in prod was still an older build from before the protocol change. And even though the message bus doesn’t care about message content, it <em>does</em> need to parse every message just to read the envelope. And the protobuf parser checks the <em>entire</em> message for missing required fields. So when Alice stopped sending that newly-optional field, the whole message failed to parse, envelope and all. And to make matters worse, any other messages that happened to be in the same batch <em>also</em> failed to parse, causing errors in seemingly-unrelated systems that share the bus.</p>

<p>Things like this have actually happened. At Google. Many times.</p>

<p>The right answer is for applications to do validation as-needed in application-level code. If you want to detect when a client fails to set a particular field, give the field an invalid default value and then check for that value on the server. Low-level infrastructure that doesn’t care about message content should not validate it at all.</p>

<p>Oh, and also, Cap’n Proto doesn’t have any parsing step during which to check for required fields. :)</p>

<h3 id="how_do_i_make_a_field_optional">How do I make a field optional?</h3>

<p>Cap’n Proto has no notion of “optional” fields.</p>

<p>A primitive field always takes space on the wire whether you set it or not (although default-valued fields will be compressed away if you enable packing). Such a field can be made semantically optional by placing it in a union with a <code>Void</code> field:</p>
<div class='highlight'><pre><code class='capnp'><span class='k'>union</span> {
  <span class='n'>age</span> <span class='nd'>@0</span> <span class='nc'>:Int32</span>;
  <span class='n'>ageUnknown</span> <span class='nd'>@1</span> <span class='nc'>:Void</span>;
}
</code></pre></div>
<p>However, this field still takes space on the wire, and in fact takes an extra 16 bits of space for the union tag. A better approach may be to give the field a bogus default value and interpret that value to mean “not present”.</p>

<p>Pointer fields are a bit different. They start out “null”, and you can check for nullness using the <code>hasFoo()</code> accessor. You could use a null pointer to mean “not present”. Note, though, that calling <code>getFoo()</code> on a null pointer returns the default value, which is indistinguishable from a legitimate value, so checking <code>hasFoo()</code> is in fact the <em>only</em> way to detect nullness.</p>

<h3 id="how_do_i_resize_a_list">How do I resize a list?</h3>

<p>Unfortunately, you can’t. You have to know the size of your list upfront, before you initialize any of the elements. This is an annoying side effect of arena allocation, which is a fundamental part of Cap’n Proto’s design: in order to avoid making a copy later, all of the pieces of the message must be allocated in a tightly-packed segment of memory, with each new piece being added to the end. If a previously-allocated piece is discarded, it leaves a hole, which wastes space. Since Cap’n Proto lists are flat arrays, the only way to resize a list would be to discard the existing list and allocate a new one, which would thus necessarily waste space.</p>

<p>In theory, a more complicated memory allocation algorithm could attempt to reuse the “holes” left behind by discarded message pieces. However, it would be hard to make sure any new data inserted into the space is exactly the right size. Fragmentation would result. And the allocator would have to do a lot of extra bookkeeping that could be expensive. This would be sad, as arena allocation is supposed to be cheap!</p>

<p>The only solution is to temporarily place your data into some other data structure (an <code>std::vector</code>, perhaps) until you know how many elements you have, then allocate the list and copy. On the bright side, you probably aren’t losing much performance this way – using vectors already involves making copies every time the backing array grows. It’s just annoying to code.</p>

<p>Keep in mind that you can use <a href="cxx.html#orphans">orphans</a> to allocate sub-objects before you have a place to put them. But, also note that you cannot allocate elements of a struct list as orphans and then put them together as a list later, because struct lists are encoded as a flat array of struct values, not an array of pointers to struct values. You can, however, allocate any inner objects embedded within those structs as orphans.</p>

<h3 id="can_i_use_capn_proto_with_visual_studio_pleeeeeaaaaassssseeeee">Can I use Cap’n Proto with Visual Studio, pleeeeeaaaaassssseeeee?</h3>

<p>We’d love that, but VS2013’s C++11 support just isn’t there yet. Many essential features are still missing. The November 2013 CTP is <em>almost</em> there, but is still missing unrestricted unions, complete constexpr support, and possibly some SFINAE tweaks.</p>

<p>We have it on the <a href="roadmap.html">roadmap</a> to do a limited backport of the code to C++03, not just for MSVC’s sake but also some other platforms that are stuck on older compilers. This will take a fair amount of work, however, and no one has yet volunteered to take this on. If you’d like to work on it, <a href="https://groups.google.com/group/capnproto">let us know</a>!</p>

<p>In the meantime, you can use Cap’n Proto on Windows with Cygwin, and version 0.5 will likely support MinGW. We realize these solutions aren’t acceptable for many people, but that’s what we can offer right now.</p>

<h2 id="personal">Personal</h2>

<h3 id="who_is_paying_you">Who is paying you?</h3>

<p>Nobody. That is, aside from <a href="https://www.gittip.com/kentonv/">Gittip</a> contributors (thanks!).</p>

<h3 id="can_i_hire_you">Can I hire you?</h3>

<p>If you would like to purchase my services on a contract basis specifically to work on features you need in Cap’n Proto or to help you apply Cap’n Proto within your business, I’d be happy to talk.</p>

<p>If you are simply looking for engineers in general and are interested in me because you are impressed with my work, I am flattered. It is especially nice when such inquiries come from other engineers rather than from headhunters. However, I am not looking for employment at this time, unless it is directly advancing Cap’n Proto.</p>
<script type="text/javascript">setupSidebar()</script>
        <div style="clear: both;"></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Cap'n Proto maintained by <a href="https://github.com/kentonv">kentonv</a>
          <span class="gplus-followbutton"><span class="g-follow" data-annotation="bubble" data-height="15" data-href="//plus.google.com/118187272963262049674" data-rel="author"></span></span>
          <a href="https://www.gittip.com/kentonv/"><img class="gittip15" src="/capnproto/images/gittip15.png" alt="Gittip"></a></p>
        <p>Design by <a href="http://www.starfruit-cafe.net/blog">sailorhg</a> ∙ Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <!-- Google+ follow button. -->
    <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>

    <!-- Google Analytics. -->
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-39711112-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>

