<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="viewport" content="width=480">

    <link rel="stylesheet" type="text/css" media="screen" href="/capnproto/stylesheets/stylesheet.css">

    <title>Cap'n Proto: Promise Pipelining and Dependent Calls: Cap'n Proto vs. Thrift vs. Ice</title>

    <script type="text/javascript" src="/capnproto/javascripts/main.js"></script>
  </head>

  <body class="desktop">

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
      <header class="inner">
        <img src="/capnproto/images/logo.png">
        <div id="infinitely_faster">
          <img src="/capnproto/images/infinitely_faster.png">
        </div>
      </header>
      <a id="discuss_banner" href="https://groups.google.com/group/capnproto">Discuss on Groups</a>
      <a id="forkme_banner" href="https://github.com/kentonv/capnproto">View on GitHub</a>
    </div>

    

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">

      <section id="menu">
        <ul>
          <li><a href="/capnproto/index.html">Introduction</a></li>
          <li><a href="/capnproto/news/">News</a></li>
          <li><a href="/capnproto/install.html">Installation</a></li>
          <li><a href="/capnproto/language.html">Schema Language</a></li>
          <li><a href="/capnproto/encoding.html">Encoding</a></li>
          <li><a href="/capnproto/rpc.html">RPC Protocol</a></li>
          <li><a href="/capnproto/capnp-tool.html">The <code>capnp</code> Tool</a></li>
          <li><a href="/capnproto/cxx.html">C++ Serialization</a></li>
          <li><a href="/capnproto/cxxrpc.html">C++ RPC</a></li>
          <li><a href="/capnproto/otherlang.html">Other Languages</a></li>
          <li><a href="/capnproto/roadmap.html">Road Map</a></li>
          <li><a href="/capnproto/faq.html">FAQ</a></li>
        </ul>
      </section>
      <section id="main_content" class="inner">


<div class="hmargin" style="float: right"><a class="groups_link" style="color: #fff"
href="https://groups.google.com/group/capnproto-announce">Stay Updated</a></div>

<h1><a href="/capnproto/news/">News</a></h1>

<h2>Promise Pipelining and Dependent Calls: Cap'n Proto vs. Thrift vs. Ice</h2>
<p class="author">
  <a href="https://github.com/kentonv">kentonv</a>
  
  <span class="gplus-followbutton"><span class="g-follow" data-annotation="none" data-height="15" data-href="//plus.google.com/118187272963262049674" data-rel="author"></span></span>
  <a href="https://www.gittip.com/kentonv/"><img class="gittip" src="/capnproto/images/gittip.png" alt="Gittip"></a>
  
  on <span class="date">13 Dec 2013</span>
</p>
<p><em>UPDATED:  Added Thrift to the comparison.</em></p>

<p>So, I totally botched the 0.4 release announcement yesterday.  I was excited about promise
pipelining, but I wasn’t sure how to describe it in headline form.  I decided to be a bit
silly and call it “time travel”, tongue-in-cheek.  My hope was that people would then be
curious, read the docs, find out that this is actually a really cool feature, and start doing
stuff with it.</p>

<p>Unfortunately, <a href="2013-12-12-capnproto-0.4-time-travel.html">my post</a> only contained a link to
the full explanation and then confusingly followed the “time travel” section with a separate section
describing the fact that I had implemented a promise API in C++.  Half the readers clicked through
to the documentation and understood.  The other half thought I was claiming that promises alone
constituted “time travel”, and thought I was ridiculously over-hyping an already-well-known
technique.  My HN post was subsequently flagged into oblivion.</p>

<p>Let me be clear:</p>

<p><strong>Promises alone are <em>not</em> what I meant by “time travel”!</strong></p>

<p><img src="/capnproto/images/capnp-vs-thrift-vs-ice.png" style="width:350px; height:275px; float: right;" /></p>

<p>So what did I mean?  Perhaps <a href="https://github.com/kentonv/capnp-vs-ice">this benchmark</a> will
make things clearer.  Here, I’ve defined a server that exports a simple four-function calculator
interface, with <code>add()</code>, <code>sub()</code>, <code>mult()</code>, and <code>div()</code> calls, each taking two integers and\
returning a result.</p>

<p>You are probably already thinking:  That’s a ridiculously bad way to define an RPC interface!
You want to have <em>one</em> method <code>eval()</code> that takes an expression tree (or graph, even), otherwise
you will have ridiculous latency.  But this is exactly the point.  <strong>With promise pipelining, simple,
composable methods work fine.</strong></p>

<p>To prove the point, I’ve implemented servers in Cap’n Proto, <a href="http://thrift.apache.org/">Apache Thrift</a>,
and <a href="http://www.zeroc.com/">ZeroC Ice</a>.  I then implemented clients against each one, where the
client attempts to evaluate the expression:</p>

<pre><code>((5 * 2) + ((7 - 3) * 10)) / (6 - 4)
</code></pre>

<p>All three frameworks support asynchronous calls with a promise/future-like interface, and all of my
clients use these interfaces to parallelize calls.  However, notice that even with parallelization,
it takes four steps to compute the result:</p>

<pre><code># Even with parallelization, this takes four steps!
((5 * 2) + ((7 - 3) * 10)) / (6 - 4)
  (10    + (   4    * 10)) /    2      # 1
  (10    +         40)     /    2      # 2
        50                 /    2      # 3
                          25           # 4
</code></pre>

<p>As such, the Thrift and Ice clients take four network round trips.  Cap’n Proto, however, takes
only one.</p>

<p>Cap’n Proto, you see, sends all six calls from the client to the server at one time.  For the
latter calls, it simply tells the server to substitute the former calls’ results into the new
requests, once those dependency calls finish.  Typical RPC systems can only send three calls to
start, then must wait for some to finish before it can continue with the remaining calls.  Over
a high-latency connection, this means they take 4x longer than Cap’n Proto to do their work in
this test.</p>

<p>So, does this matter outside of a contrived example case?  Yes, it does, because it allows you to
write cleaner interfaces with simple, composable methods, rather than monster do-everything-at-once
methods.  The four-method calculator interface is much simpler than one involving sending an
expression graph to the server in one batch.  Moreover, pipelining allows you to define
object-oriented interfaces where you might otherwise be tempted to settle for singletons.  See
<a href="/capnproto/rpc.html#introduction">my extended argument</a> (this is what I was trying to get
people to click on yesterday :) ).</p>

<p>Hopefully now it is clearer what I was trying to illustrate with this diagram, and what I meant
by “time travel”!</p>

<p><img src="/capnproto/images/time-travel.png" style="max-width:639px" /></p>

<script type="text/javascript">setupNewsSidebar([
    
      { title: "Cap'n Proto 0.5: Generics, Visual C++, Java, C#, Sandstorm.io", url: "/capnproto/./news/2014-12-15-capnproto-0.5-generics-msvc-java-csharp.html" },
    
      { title: "Cap'n Proto, FlatBuffers, and SBE", url: "/capnproto/./news/2014-06-17-capnproto-flatbuffers-sbe.html" },
    
      { title: "Cap'n Proto 0.4.1: Bugfix Release", url: "/capnproto/./news/2014-03-11-capnproto-0.4.1-bugfixes.html" },
    
      { title: "Promise Pipelining and Dependent Calls: Cap'n Proto vs. Thrift vs. Ice", url: "/capnproto/./news/2013-12-13-promise-pipelining-capnproto-vs-ice.html" },
    
      { title: "Cap'n Proto v0.4: Time Traveling RPC", url: "/capnproto/./news/2013-12-12-capnproto-0.4-time-travel.html" },
    
      { title: "Cap'n Proto v0.3: Python, tools, new features", url: "/capnproto/./news/2013-09-04-capnproto-0.3-python-tools-features.html" },
    
      { title: "Cap'n Proto v0.2.1: Minor bug fixes", url: "/capnproto/./news/2013-08-19-capnproto-0.2.1.html" },
    
      { title: "Cap'n Proto v0.2: Compiler rewritten Haskell -> C++", url: "/capnproto/./news/2013-08-12-capnproto-0.2-no-more-haskell.html" },
    
      { title: "Cap'n Proto Beta Release", url: "/capnproto/./news/2013-06-27-capn-proto-beta-release.html" },
    
      { title: "Announcing Cap'n Proto", url: "/capnproto/./news/2013-04-01-announcing-capn-proto.html" },
    
    ]);</script>
        <div style="clear: both;"></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Cap'n Proto maintained by <a href="https://github.com/kentonv">kentonv</a>
          <span class="gplus-followbutton"><span class="g-follow" data-annotation="bubble" data-height="15" data-href="//plus.google.com/118187272963262049674" data-rel="author"></span></span>
          <a href="https://www.gittip.com/kentonv/"><img class="gittip15" src="/capnproto/images/gittip15.png" alt="Gittip"></a></p>
        <p>Design by <a href="http://www.starfruit-cafe.net/blog">sailorhg</a> ∙ Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <!-- Google+ follow button. -->
    <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>

    <!-- Google Analytics. -->
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-39711112-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>

